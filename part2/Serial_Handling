#include "serial_handling.h"
//#include "serialport.h"
//MCUFRIEND_kbv tft;
extern shared_vars shared;

String readData(){
  String line = "";
  int time = millis();
  while(true){
    if(millis() - time >= 1000){
      return line;
    }
    if(Serial.available() != 0){
      char data = Serial.read();
      line = line+data;
      if(data == "\n"){
        return line;
      }
    }
  }
  
}

uint8_t get_waypoints(const lon_lat_32& start, const lon_lat_32& end) {
  while(Serial.available() > 0){
    Serial.read();
  }
  String startLon = String(start.lon);
  String startLat = String(start.lat);
  String endLon = String(end.lon);
  String endLat = String(end.lat);
  //list<pair<int, int>> path;
  
  String stringTogether = "R " + startLat + " " + startLon + " " + endLat + " " + endLon + "\n";
  Serial.print(stringTogether);
  Serial.flush();
  int numCommands;
  String commandLine = readData();
  if(commandLine[0] == 'N'){
    numCommands = commandLine.substring(2).toInt();
    Serial.print("A\n");
    Serial.flush();
    Serial.print(numCommands);
    // shared.num_waypoints = numCommands;
    for(int i = 0; i < numCommands; i++){
      commandLine = readData();
      Serial.print(commandLine);
      Serial.print("A\n");
      Serial.flush();
    }
    Serial.println("DOne!");
  }
  return 1;
}
//   if(test){
//     while(true){
//       String data = readData();
//       Serial.print(data);
//       Serial.flush();
//       if(data.substring(0,1)=='W'){
//         Serial.print("A\n");
//         Serial.flush();
//       }else if(data=="E\n"){
//         Serial.print("A\n");
//         Serial.flush();
//         return 1;
//       }else{
//         return 0;
//       }
//     }
//   }
// }
  

  // int i = 0;
  // while(i < numCommands){
    
  //   String commandLine = readData();
  //   Serial.print(commandLine);
  //   if(commandLine.substring(0,1) == 'W'){
  //     int lat = (commandLine.substring(2, 9)).toInt();
  //     int lon = (commandLine.substring(10)).toInt();
  //     shared.waypoints[i].lon = lon;
  //     shared.waypoints[i].lat = lat;

  //     Serial.print("A\n");
  //     Serial.flush();
  //     break;
  //   }
  //   i++;
  // }


  // commandLine = readData();
  // if(i + 1 == numCommands){
    
  //   if(commandLine[0] == "E"){
  //     return 1;
      
  //   }
  // }
    
  
    //String readInLine = readline(10000);

    //   if(readInLine != ""){
    //     String substr = readInLine.substring(0,2);
    //     if(substr == "W"){

    //       int start = substr.indexOf(' ');
    //       int end = substr.indexOf(' ', start + 1);
    //       String lat = substr.substring(start + 1, end);
    //       start = end;
    //       end = substr.indexOf('\n', start + 1);
    //       String lon = substr.substring(start + 1, end);
          
    //       int latInt = lat.toInt();
    //       int lonInt = lon.toInt();

    //       shared.waypoints[i].lon = lonInt;
    //       shared.waypoints[i].lat = latInt;

    //       bool acknol = writeline("A\n");

    //       if(!(acknol)){
    //         break;
    //       } else {
    //         i++;
    //       }
    //     }
    //   }
    // }

    // if(i + 1 == numCommands){
    //   String endMessage = readline(10000);
    //   if(endMessage == "E\n"){
    //     return 1;
    //   }
    // }
